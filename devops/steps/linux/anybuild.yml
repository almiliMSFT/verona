parameters:
  - name: BuildName
    type: string
  - name: BuildCommandLine
    type: string
  - name: WorkingDirectory
    type: string
  - name: Condition
    type: string
    default: succeeded()
  - name: ExtraAnyBuildArgs
    type: string
    default: --WhyCacheMiss

steps:
- bash: |
    set -euo pipefail

    echo "=== Downloading AnyBuild from $(AnyBuildSource)"
    wget -O- $(AnyBuildSource)/bootstrapper.sh | bash -s $(AnyBuildSource) $(AnyBuildRing)
  displayName: Install AnyBuild Client

- bash: |
    set -euo pipefail

    echo "===== Running '${{ parameters.BuildCommandLine }}' from $(pwd)"
    echo

    readonly abClientExe="$HOME/.local/share/Microsoft/AnyBuild/AnyBuild.sh"

    env -i                                                                \
      SECRET=$(LLVMPrincipalPassword)                                     \
      HOME="$HOME"                                                        \
      PATH="$PATH"                                                        \
    "$abClientExe"                                                        \
      --RemoteExecServiceUri $(AnyBuildEnvironmentUri)                    \
      --NoCheckForUpdates                                                 \
      --WaitForAgentForever                                               \
      --DoNotUseMachineUtilizationForScheduling                           \
      --ClientApplicationId $(LLVMPrincipalAppId)                         \
      --ClientSecretEnvironmentVariable SECRET                            \
      --ExperimentName "${{ parameters.BuildName }}"                      \
      ${{ parameters.ExtraAnyBuildArgs }}                                 \
      --WhyCacheMissOptions CacheDataStoreKey=${{ parameters.BuildName }} \
      --                                                                  \
      ${{ parameters.BuildCommandLine }}
  workingDirectory: ${{ parameters.WorkingDirectory }}
  displayName: AnyBuild ${{ parameters.BuildName }}

- template: ../print-anybuild-stats.yml
  parameters:
    LogsDir: ${{ parameters.WorkingDirectory }}

- template: ../publish-anybuild-logs.yml
  parameters:
    LogsDir: ${{ parameters.WorkingDirectory }}
    ArtifactName: AnyBuildLogs-${{ parameters.BuildName }}-linux.$(Build.BuildId)
